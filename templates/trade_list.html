{% extends "base.html" %}
{% load i18n %}
{% block head_title %}{% trans "Trade List" %}{% endblock head_title %}

{% block content %}
<div class="p-5 m-3">
    <table class="table">
        <tbody>
            <tr>
                <th>Symbol</th>
                <th>Date</th>
                <th>Status</th>
                <th>L / S</th>
                <th>Position</th>
                <th>Margin</th>
                <th>Leverage</th>
                <th>Open $</th>
                <th>Closed $</th>
                <th>Return PnL</th>
            </tr>
        <tbody>
            {%for trade in trades%}
            <tr id="tradeRow{{ trade.id }}">
                <td>{{ trade.symbol }}</td>
                <td>{{ trade.date }}</td>
                <td>{{ trade.status }}</td>
                <td>{{ trade.long_short }}</td>
                <td>{{ trade.position }}</td>
                <td>{{ trade.margin }}</td>
                <td>{{ trade.leverage }}</td>
                <td>{{ trade.open_price }}</td>
                <td>{{ trade.current_price }}</td>
                <td>{{ trade.return_pnl }}</td>
                <td>
                    <!-- Delete button -->
                    <button class="btn btn-secondary btn-sm square-btn bg-black" onclick="deleteTrade('{{ trade.id }}')">X</button>
                </td>
            </tr>

            {% endfor %}
            <button id="showCreateTradeForm" class="btn btn-primary mb-3">Create Trade</button>
            <div id="createTradeForm">
                <form method="post" action="{% url 'trade_list_post' %}" id="createTradeForm">
                    {% csrf_token %}
                    <td>
                        <div class="hide-cell">
                            <label for="{{ form.symbol.id_for_label }}" class="form-label"></label>
                            {{ form.symbol }}
                        </div>
                    </td>
                    <td>
                        <div class="hide-cell">
                            <label for="{{ form.date.id_for_label }}" class="form-label"></label>
                            {{ form.date }}
                        </div>
                    </td>
                    <td>
                        <div class="hide-cell">
                            <label for="{{ form.status.id_for_label }}" class="form-label"></label>
                            {{ form.status }}
                        </div>
                    </td>
                    <td>
                        <div class="hide-cell m-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label"></label>
                            {{ form.long_short }}
                        </div>
                    </td>
                    <td>
                        <div class="hide-cell">
                            <label for="{{ form.margin.id_for_label }}" class="form-label"></label>
                            {{ form.position }}
                        </div>
                    </td>
                    <td>
                        <div class="hide-cell">
                            <label for="{{ form.margin.id_for_label }}" class="form-label"></label>
                            {{ form.margin }}
                        </div>
                    </td>
                    <td>
                        <div class="hide-cell">
                            <label for="{{ form.leverage.id_for_label }}" class="form-label"></label>
                            {{ form.leverage }}
                        </div>
                    </td>
                    <td>
                        <div class="hide-cell">
                            <label for="{{ form.open_price.id_for_label }}" class="form-label"></label>
                            {{ form.open_price }}
                        </div>
                    </td>
                    <td>
                        <div class="hide-cell">
                            <label for="{{ form.current_price.id_for_label }}" class="form-label"></label>
                            {{ form.current_price }}
                        </div>
                    </td>

                    <td>
                        <div class="hide-cell">
                            <label for="{{ form.return_pnl.id_for_label }}" class="form-label"></label>
                            {{ form.return_pnl }}
                        </div>

                    </td>

                    <div class="hide-cell save-button">
                        <label for="{{ form.return_pnl.id_for_label }}" class="form-label"></label>
                        <button type="submit" class="btn btn-success">Save</button>
                    </div>
                    <br>
                </form>
            </div>
        </tbody>
    </table>

</div>

<script defer>
    document.addEventListener('DOMContentLoaded', function () {
        const createTradeForm = document.getElementById('createTradeForm');
        const showCreateTradeForm = document.getElementById('showCreateTradeForm');
        const hideCells = document.querySelectorAll('.hide-cell');
        const createTradeButton = document.getElementById('showCreateTradeForm');

        showCreateTradeForm.addEventListener('click', function () {
            createTradeForm.classList.toggle('hidden-form');

            // Toggle the visibility of the hide-cell elements
            hideCells.forEach(function (cell) {
                cell.classList.toggle('hidden-cell');
            });

            // Hide the "Create Trade" button
            createTradeButton.style.display = 'none';
        });
    });


    function deleteTrade(tradeId) {
        // Get the CSRF token from the page
        const csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;

        // Using fetch to send a DELETE request to the server
        fetch(`/delete-trade/${tradeId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            credentials: 'include', // Include credentials (e.g., cookies) in the request
        })
            .then(response => response.json())
            .then(data => handleDeleteResponse(data, tradeId))
            .catch(error => console.error('Error:', error));
    }

    function handleDeleteResponse(data, tradeId) {
        // Handle the response from the server
        if (data.success) {
            // If the deletion was successful, remove the row from the UI
            const row = document.getElementById(`tradeRow${tradeId}`);
            if (row) {
                row.remove();
            }
            // Add a message or log to indicate success
            console.log('Trade successfully deleted:', tradeId);
            // Refresh the page
            window.location.reload();
        } else {
            // Handle errors or provide feedback to the user
            console.error('Deletion failed:', data.error);
            // You might want to display an error message to the user
        }
    }



</script>


{% endblock content %}