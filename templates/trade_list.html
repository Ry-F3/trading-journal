{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block head_title %}{% trans "Trade List" %}{% endblock head_title %}

{% block content %}

<div class="p-5 m-3">
    <table class="table">
        <tbody>
            <tr>
                <th>Symbol</th>
                <th>Date</th>
                <th>Status</th>
                <th>L / S</th>
                <th>Risk</th>
                <th>Margin</th>
                <th>Leverage</th>
                <th>Open</th>
                <th>Closed</th>
                <th>Return PnL</th>
            </tr>
        <tbody>
            {%for trade in trades%}
            <tr id="tradeRow{{ trade.id }}">
                <td>{{ trade.symbol }}</td>
                <td>{{ trade.date }}</td>
                <td>{{ trade.status }}</td>
                <td>{{ trade.long_short }}</td>
                <td>{{ trade.position }}%</td>
                <td>${{ trade.margin }}</td>
                <td>{{ trade.leverage }}x</td>
                <td>${{ trade.open_price }}</td>
                <td>${{ trade.current_price }}</td>
                <td>${{ trade.return_pnl }}</td>

                <td>
                    <!-- Edit button with pencil icon -->
                    <button class="square-btn" onclick="editTrade('{{ trade.id }}')">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </td>

                <td>
                    <!-- Delete button -->
                    <button class="btn btn-secondary btn-sm square-btn bg-black"
                        onclick="deleteTrade('{{ trade.id }}')">X</button>
                </td>
            </tr>

            {% endfor %}
            <button id="showCreateTradeForm" class="btn btn-primary mb-3">Create Trade</button>
            <div id="createTradeForm" class="hidden-form">
                <form method="post" action="{% url 'trade_list_post' %}" id="createTradeForm">
                    {% csrf_token %}
                    <tr>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.symbol }}</div>
                        </td>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.date }}</div>
                        </td>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.status }}</div>
                        </td>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.long_short }}</div>
                        </td>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.position }}</div>
                        </td>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.margin }}</div>
                        </td>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.leverage }}</div>
                        </td>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.open_price }}</div>
                        </td>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.current_price }}</div>
                        </td>
                        <td class="hide-cell">
                            <div class="mb-2 mt-1">{{ form.return_pnl }}</div>
                        </td>
                        <td class="hide-cell save-button" colspan="2">
                            <button type="submit" class="btn btn-success">Save</button>
                        </td>
                    </tr>
                </form>
            </div>
        </tbody>
    </table>

</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="{% static 'js/form.js' %}"></script>


<script defer>


    document.addEventListener('DOMContentLoaded', function () {
        const createTradeForm = document.getElementById('createTradeForm');
        const showCreateTradeForm = document.getElementById('showCreateTradeForm');
        const hideCells = document.querySelectorAll('.hide-cell');
        const createTradeButton = document.getElementById('showCreateTradeForm');

        showCreateTradeForm.addEventListener('click', function () {
            createTradeForm.classList.toggle('hidden-form');

            // Toggle the visibility of the hide-cell elements
            hideCells.forEach(function (cell) {
                cell.classList.toggle('hidden-cell');
            });

            // Fetch the next available row number from the server
            fetch('/get_next_row_number/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const nextRowNumber = data.next_row_number;

                        // Update the form fields to reflect the new row number
                        $('#id_symbol').val(data.trade_details.symbol);
                        $('#id_date').val(data.trade_details.date);
                        $('#id_status').val(data.trade_details.status);
                        $('#id_long_short').val(data.trade_details.long_short);
                        $('#id_position').val(data.trade_details.position);
                        $('#id_margin').val(data.trade_details.margin);
                        $('#id_leverage').val(data.trade_details.leverage);
                        $('#id_open_price').val(data.trade_details.open_price);
                        $('#id_current_price').val(data.trade_details.current_price);
                        $('#id_return_pnl').val(data.trade_details.return_pnl);

                        // Update the form action URL if needed
                        const formAction = `/create-trade/${nextRowNumber}/`; // Adjust the URL pattern
                        createTradeForm.action = formAction;

                        // Display the form for editing
                        $(createTradeForm).removeClass('hidden-form');

                        // Log success
                        console.log('Form should be populated and visible now');
                    } else {
                        console.error('Error fetching next row number:', data.error);
                    }

                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
        });

    });


    function deleteTrade(tradeId) {
        // Get the CSRF token from the page
        const csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;

        // Using fetch to send a DELETE request to the server
        fetch(`/delete-trade/${tradeId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            credentials: 'include', // Include credentials (e.g., cookies) in the request
        })
            .then(response => response.json())
            .then(data => handleDeleteResponse(data, tradeId))
            .catch(error => console.error('Error:', error));
    }
    function handleDeleteResponse(data, tradeId) {
        // Handle the response from the server
        if (data.success) {
            // If the deletion was successful, remove the row from the UI
            const row = document.getElementById(`tradeRow${tradeId}`);
            if (row) {
                row.remove();

                // Fetch the next available row number from the server
                fetch('/get_next_row_number/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const nextRowNumber = data.next_row_number;

                            // Update row numbers in the UI after deletion
                            const rows = document.querySelectorAll('.trade-row');
                            rows.forEach((row, index) => {
                                const newTradeId = index + 1;
                                row.id = `tradeRow${newTradeId}`;
                                const buttons = row.getElementsByTagName('button');
                                // Update the deleteTrade and editTrade functions with the new tradeId
                                for (let i = 0; i < buttons.length; i++) {
                                    if (buttons[i].onclick) {
                                        const functionName = buttons[i].onclick.toString().split('\'')[1];
                                        buttons[i].setAttribute('onclick', `${functionName}('${newTradeId}')`);
                                    }
                                }
                            });

                            // Update the form fields to reflect the new row number
                            $('#id_symbol').val('');
                            $('#id_date').val('');
                            $('#id_status').val('');
                            $('#id_long_short').val('');
                            $('#id_position').val('');
                            $('#id_margin').val('');
                            $('#id_leverage').val('');
                            $('#id_open_price').val('');
                            $('#id_current_price').val('');
                            $('#id_return_pnl').val('');
                            // ... (update other form fields)

                            // Update the form action URL if needed
                            const formAction = `/create-trade/${nextRowNumber}/`; // Adjust the URL pattern
                            createTradeForm.action = formAction;

                            // Display the form for editing
                            $(createTradeForm).removeClass('hidden-form');

                            // Log success
                            console.log('Form should be populated and visible now');
                        } else {
                            console.error('Error fetching next row number:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
            } else {
                console.error('Row not found in the DOM:', `tradeRow${tradeId}`);
            }
        } else {
            // Handle errors or provide feedback to the user
            console.error('Deletion failed:', data.error);
        }
    }

    function editTrade(rowNumber) {
        if (rowNumber !== null) {
            console.log('Attempting to fetch trade details for row:', rowNumber);
            fetch(`/get_trade_details_by_row/${rowNumber}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log('Fetched trade details:', data.trade_details);

                        // Update the form fields with the received data
                        $('#id_symbol').val(data.trade_details.symbol);
                        $('#id_date').val(data.trade_details.date);
                        $('#id_status').val(data.trade_details.status);
                        $('#id_long_short').val(data.trade_details.long_short);
                        $('#id_position').val(data.trade_details.position);
                        $('#id_margin').val(data.trade_details.margin);
                        $('#id_leverage').val(data.trade_details.leverage);
                        $('#id_open_price').val(data.trade_details.open_price);
                        $('#id_current_price').val(data.trade_details.current_price);
                        $('#id_return_pnl').val(data.trade_details.return_pnl);

                        // Display the form for editing
                        $(createTradeForm).removeClass('hidden-form');


                        // Log success
                        console.log('Form should be populated and visible now');
                    } else {
                        console.error('Error fetching trade details:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
        }
    }


    function handleEditResponse(data, rowNumber) {
        console.log('Handling edit response for row:', rowNumber);
        const editedRow = document.getElementById(`tradeRow${rowNumber}`);
        const createTradeForm = document.getElementById('createTradeForm');
        const hideCells = document.querySelectorAll('.hide-cell');
        const createTradeButton = document.getElementById('showCreateTradeForm');

        if (editedRow) {
            if (data.success) {
                // If the edit was successful, update the row in the UI
                if (data.trade_details) {
                    // Update the form fields with the received data
                    $('#id_symbol').val(data.trade_details.symbol);
                    $('#id_date').val(data.trade_details.date);
                    $('#id_status').val(data.trade_details.status);
                    $('#id_long_short').val(data.trade_details.long_short);
                    $('#id_position').val(data.trade_details.position);
                    $('#id_margin').val(data.trade_details.margin);
                    $('#id_leverage').val(data.trade_details.leverage);
                    $('#id_open_price').val(data.trade_details.open_price);
                    $('#id_current_price').val(data.trade_details.current_price);
                    $('#id_return_pnl').val(data.trade_details.return_pnl);

                    createTradeForm.classList.remove('hidden-form');
                    hideCells.forEach(function (cell) {
                        cell.classList.remove('hidden-cell');
                    });
                    createTradeButton.style.display = 'none';

                    // Log to indicate success
                    console.log('Trade successfully edited:', data.trade_details);
                } else {
                    console.error('Edited trade row data is missing:', data);
                }
            } else {
                // Handle errors or provide feedback to the user
                console.error('Edit failed:', data.error);
            }
        } else {
            console.error('Edited row not found in the DOM:', `tradeRow${rowNumber}`);
        }
    }

</script>



{% endblock content %}