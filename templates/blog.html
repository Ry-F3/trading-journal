{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block head_title %}{% trans "Blog" %}{% endblock head_title %}
<!-- Heading -->
{% block heading_blog %}
<h1 class="h4 m-1 text-muted">Blog</h1>
<div class="d-none d-sm-inline-block">
    <button type="button" class="btn btn-sm bg-dk-blue shadow-sm" data-bs-toggle="modal"
        data-bs-target="#createPostModal">
        <i class="fas fa-download fa-sm text-white-50"></i> Create Post
    </button>
</div>

<!-- Modal -->
<div class="modal fade" id="createPostModal" tabindex="-1" role="dialog" aria-labelledby="createPostModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <!-- Profile Picture Circle Box and Username -->
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-dk-blue overflow-hidden mx-1" style="width: 35px; height: 35px;">
                        <!-- No need for the img tag if you want a solid color -->
                    </div>
                    <h5 class="modal-title mx-2" id="createPostModalLabel">{{ request.user.username }}</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'blog' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- Post Title Input -->
                    <div class="mb-2">
                        <input type="text" class="form-control" name="title" placeholder="Post Title" required>
                    </div>
                    <!-- Content Input with Placeholder -->
                    <div class="mb-3">
                        <textarea class="form-control" name="content" placeholder="What do you want to talk about?"
                            required></textarea>
                    </div>
                    <!-- Trade Search Container -->
                    <div id="trade-container" style="display: none; align-items: center;">
                        <!-- Trade Search Input -->
                        <div class="mb-2" style="flex: 1;">
                            <input type="text" id="trade-search" class="form-control"
                                placeholder="Search for a trade by ID" style="width: 70%;">
                        </div>
                        <!-- Display a preview of the generated img here -->
                        <img id="trade-image-preview" src="" alt="Trade Image Preview"
                            style="max-width: 30%; height: auto; display: none;">
                        <input style="width: 100%;" type="hidden" id="trade-image" name="trade_image" value="">
                        <!-- Checkbox and its label container -->
                    </div>
                    <!-- Display selected trade details here -->
                    <div id="selected-trade-details" class="mb-2 mt-2">
                        <p class="mx-2" id="selected-trade-info"></p>
                        <a id="download-image-link" href="#" style="display: none;"><i class="fas fa-download"></i>
                            Download Image</a>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <div class="mb-2">
                            <input type="file" name="trade_image">
                        </div>
                        <!-- Share Trade Button -->
                        <button type="button" class="btn btn-secondary" id="share-trade-btn">Share Trade</button>
                        <button id="post-btn" type="submit" class="btn bg-dk-blue">Post <i
                                class="fas fa-edit"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Main Script -->
<script>
    $(document).ready(function () {
        // Function to handle trade search
        function searchTrade(query) {
            console.log('Searching for trade with query:', query);

            // Make an AJAX request to your backend to get user-specific trade details based on the query
            $.ajax({
                type: 'GET',
                url: '/search_trade/',
                data: {
                    'query': query,
                    'user_id': '{{ request.user.id }}'  // Pass the user's ID to the backend
                },
                success: function (response) {
                    console.log('Search results:', response);

                    // Update the search results
                    $('#search-results').empty(); // Clear previous results

                    // Display selected trade details
                    if (response.length > 0) {
                        var detailsHtml = "Selected trade: ";
                        for (var i = 0; i < response.length; i++) {
                            detailsHtml += `${response[i].symbol} on ${response[i].date}<br>`;
                            // Set selected trade details
                            selectedTradeDetails = JSON.stringify(response[i]);

                            toggleAttachTradeContainer(response.length > 0);
                        }
                        $('#selected-trade-info').html(detailsHtml);

                        // Function to toggle the visibility of the checkbox container
                        function toggleAttachTradeContainer(showContainer) {
                            if (showContainer) {
                                // Show the checkbox and its label container
                                $('#attach-trade-container').css('display', 'flex');
                            } else {
                                // Hide the checkbox and its label container
                                $('#attach-trade-container').css('display', 'none');
                            }
                        }

                        // Display a preview of generated img here
                        const tradeDetails = response[0];
                        const tradeImageSrc = generateTradeImagePreview(tradeDetails);
                        $('#trade-image-preview').attr('src', tradeImageSrc).show();

                        // Set the base64-encoded image data to the hidden field
                        $('#trade-image').val(tradeImageSrc);
                    } else {
                        console.log('No trades found.');
                        $('#selected-trade-info').html('No trades found.');
                        // Hide the image preview if no trade is found
                        $('#trade-image-preview').hide();
                    }
                },
                error: function (error) {
                    console.error('Error during trade search:', error);
                }
            });

        }

        // Function to generate trade image preview 
        function generateTradeImagePreview(tradeDetails) {
            // Show the download link
            $('#download-image-link').show();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 500;
            canvas.height = 450;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // Draw overlay text
            ctx.fillStyle = 'white';
            ctx.fillStyle = '#CCCCCC';
            ctx.font = '60px Roboto';
            ctx.fillText(`${tradeDetails.symbol} | ${tradeDetails.long_short} | ${tradeDetails.leverage}x`, 20, 115);
            // Display return pnl with appropriate formatting
            const returnPnlText = (tradeDetails.return_pnl < 0 ? '-$' : '+$') + Math.abs(tradeDetails.return_pnl);
            ctx.font = '80px Roboto';
            ctx.fillStyle = '#0231f1';
            ctx.fillText(returnPnlText, 20, 225);
            ctx.fillStyle = '#CCCCCC';
            ctx.font = '22px Roboto';
            ctx.fillText(`Close Price  $${tradeDetails.current_price}       ${tradeDetails.user_name}`, 20, 285);
            ctx.fillText(`Avg. Open Price  $${tradeDetails.open_price}      ${tradeDetails.date}`, 20, 320);
            ctx.font = '40px Roboto';
            return canvas.toDataURL('image/png');
        }

        // Event listener for "Download Image" link
        $('#download-image-link').on('click', function (e) {
            e.preventDefault();

            // Get the data URL of the generated image
            var tradeImageSrc = $('#trade-image-preview').attr('src');

            // Create a temporary link element
            var downloadLink = document.createElement('a');
            downloadLink.href = tradeImageSrc;
            downloadLink.download = 'trade_image.png';

            // Trigger the click event on the link
            downloadLink.click();
        });

        // Event listener for trade search input
        $('#trade-search').on('input', function () {
            // Get the input value
            var query = $(this).val();

            // Call the searchTrade function with the original input value
            searchTrade(query);
        });

        // Event listener for "Share Trade" button
        $('#share-trade-btn').on('click', function () {
            // Toggle the visibility of the trade container
            $('#trade-container').toggle();
            $('#download-image-link').hide();

            // Set display: flex when the container is visible
            if ($('#trade-container').is(':visible')) {
                $('#trade-container').css('display', 'flex');
            }

            // Reset the form when the modal is closed
            if (!$('#trade-container').is(':visible')) {
                resetTradeForm();
            }
        });

        // Function to reset trade-related form elements
        function resetTradeForm() {
            // Clear the input value
            $('#trade-search').val('');

            // Clear the selected trade details
            $('#selected-trade-info').html('');

            // Hide the image preview
            $('#trade-image-preview').hide();

            // Reset the base64-encoded image data in the hidden field
            $('#trade-image').val('');

        }

        // Alternatively, you can use the button's data-bs-dismiss attribute
        $('.btn-close').click(function () {
            resetTradeForm();
            $('#trade-container').toggle();
            $('#download-image-link').hide();
        });

        // Function to toggle the visibility of the checkbox container
        function toggleAttachTradeContainer(showContainer) {
            if (showContainer) {
                $('#attach-trade-container').css('display', 'flex');
            } else {
                $('#attach-trade-container').css('display', 'none');
            }
        }

        // Event listener for "Share Trade" button
        $('#share-trade-btn').on('click', function () {
            // Toggle the visibility of the trade container
            $('#trade-container').toggle();

            // Reset the form when the modal is closed
            if (!$('#trade-container').is(':visible')) {
                resetTradeForm();
            }
        });


        // Event listener for "Share Trade" button
        $('#share-trade-btn').on('click', function () {
            // Toggle the visibility of the trade container
            $('#trade-container').toggle();
        });

        // Event listener for "Post" button
        $('#post-btn').on('click', function () {
            // Validate required fields
            var title = $('input[name="title"]').val();
            var content = $('textarea[name="content"]').val();
            var selectedTradeDetails = $('#selected-trade-details').val();

            if (!title || !content) {
                alert('Please fill in all required fields.');
                return;
            }

            // Call the function before posting
            handleTradeDetails();

            alert('Posting trade image with attached trade details...');
        });

    });

</script>

{% endblock heading_blog %}

<!-- Sidebar Header -->
{% block sidebar_header_blog %}
<div class="card-header py-3 d-flex flex-row align-items-center bg-dk-grey justify-content-between" data-bs-toggle="collapse"
    data-bs-target="#sidebarCollapse">
    <h6 class="m-0 font-weight-bold text-white">
        Recent Posts
    </h6>
    <span class="toggle-icon pointer">&#x25BC;</span>
</div>

{% endblock sidebar_header_blog %}

<!-- Sidebar ## -->
{% block sidebar_blog %}
<style>
    /* Thin scrollbar for WebKit browsers (Chrome, Safari) */
    .all-posts-box::-webkit-scrollbar {
        width: 8px;
    }

    .all-posts-box::-webkit-scrollbar-thumb {
        background-color: #ced4da;
        border-radius: 4px;
    }

    .all-posts-box::-webkit-scrollbar-track {
        background-color: #f8f9fa;
    }
</style>

<!-- Display a separate box for viewing all posts as a list -->
<div class="all-posts-box p-3 rounded text-center" style="max-height: 300px; overflow-y: auto; width: 120%;">
    <ul class="list-group">
        {% for post in remaining_posts %}
        <li class="list-group-item small mb-1 bg-light">
            <span class="font-weight-bold text-muted">{{ post.user.username }}</span> -
            <span class="text-muted">{{ post.timestamp }}</span> -
            <a href="{% url 'view_post' post.id %}" class="txt-dk-blue">{{ post.title }}</a>
        </li>
        {% endfor %}
    </ul>
</div>

{% endblock sidebar_blog %}

{% block blog_content %}
{% for post in posts_sets.0 %}
<div class="box-1">
    <div class="d-flex align-items-center justify-content-start mt-2">
        <div class="rounded-circle bg-dk-blue overflow-hidden mx-1" style="width: 35px; height: 35px;"></div>
        <div class="ml-2">
            <h3 class="small"><strong>{{ post.user.username }}</strong></h3>
            <h3 class="small">{{ post.timestamp }}</h3>
        </div>
    </div>
    <h4>{{ post.title }}</h4>
    <p>{{ post.content }}</p>
    <div class="container">
        <hr>
    </div>
    <div class="d-flex justify-content-between align-items-end">
        {% if post.trade_image and 'placeholder' not in post.trade_image.url %}
        <!-- Actual Trade Image -->
        <img src="{{ post.trade_image.url }}" style="width: 50%;" alt="Trade Image">
        {% else %}
        <!-- Placeholder Image -->
        <img src="https://res.cloudinary.com/dwkn0vexk/image/upload/v1704492166/shutterstock_2281731899_vmmls4.jpg"
            style="width: 50%;" alt="Placeholder">
        {% endif %}
        <form method="post" action="{% url 'like_toggle' %}" class="like-form d-flex align-items-center p-2">
            {% csrf_token %}
            <input type="hidden" name="object_id" value="{{ post.id }}">
            <button type="submit" class="bg-transparent outline-0 border-0 like-button">
                {% if user_name and post.id in like_counts %}
                <i class="fas fa-thumbs-up fa-1x"></i>
                {% else %}
                <i class="far fa-thumbs-up fa-1x"></i>
                {% endif %}
            </button>
            <p class="like-count ml-2 mt-4" data-object-id="{{ post.id }}">{{ total_like_count }}</p>
        </form>
    </div>
</div>

{% endfor %}
{% endblock blog_content %}

{% block blog_content_two %}
{% for post in posts_sets.1 %}
<div class="box-2">
    <div class="d-flex align-items-center justify-content-start mt-2">
        <div class="rounded-circle bg-dk-blue overflow-hidden mx-1" style="width: 35px; height: 35px;"></div>
        <div class="ml-2">
            <h3 class="small"><strong>{{ post.user.username }}</strong></h3>
            <h3 class="small">{{ post.timestamp }}</h3>
        </div>
    </div>
    <h4>{{ post.title }}</h4>
    <p>{{ post.content }}</p>
    <div class="container">
        <hr>
    </div>
    <div class="d-flex justify-content-between align-items-end">
        {% if post.trade_image and 'placeholder' not in post.trade_image.url %}
        <!-- Actual Trade Image -->
        <img src="{{ post.trade_image.url }}" style="width: 50%;" alt="Trade Image">
        {% else %}
        <!-- Placeholder Image -->
        <img src="https://res.cloudinary.com/dwkn0vexk/image/upload/v1704492166/shutterstock_2281731899_vmmls4.jpg"
            style="width: 50%;" alt="Placeholder">
        {% endif %}
        <form method="post" action="{% url 'like_toggle' %}" class="like-form d-flex align-items-center p-2">
            {% csrf_token %}
            <input type="hidden" name="object_id" value="{{ post.id }}">
            <button type="submit" class="bg-transparent outline-0 border-0 like-button">
                {% if user_name and post.id in like_counts %}
                <i class="fas fa-thumbs-up fa-1x"></i>
                {% else %}
                <i class="far fa-thumbs-up fa-1x"></i>
                {% endif %}
            </button>
            <p class="like-count ml-2 mt-4" data-object-id="{{ post.id }}">{{ total_like_count }}</p>
        </form>
    </div>
</div>
{% endfor %}
{% endblock blog_content_two %}

{% block blog_content_three %}
{% for post in posts_sets.2 %}
<div class="box-3">
    <div class="d-flex align-items-center justify-content-start mt-2">
        <div class="rounded-circle bg-dk-blue overflow-hidden mx-1" style="width: 35px; height: 35px;"></div>
        <div class="ml-2">
            <h3 class="small"><strong>{{ post.user.username }}</strong></h3>
            <h3 class="small">{{ post.timestamp }}</h3>
        </div>
    </div>
    <h4>{{ post.title }}</h4>
    <p>{{ post.content }}</p>
    <div class="container">
        <hr>
    </div>
    <div class="d-flex justify-content-between align-items-end">
        {% if post.trade_image and 'placeholder' not in post.trade_image.url %}
        <!-- Actual Trade Image -->
        <img src="{{ post.trade_image.url }}" style="width: 50%;" alt="Trade Image">
        {% else %}
        <!-- Placeholder Image -->
        <img src="https://res.cloudinary.com/dwkn0vexk/image/upload/v1704492166/shutterstock_2281731899_vmmls4.jpg"
            style="width: 50%;" alt="Placeholder">
        {% endif %}
        <form method="post" action="{% url 'like_toggle' %}" class="like-form d-flex align-items-center p-2">
            {% csrf_token %}
            <input type="hidden" name="object_id" value="{{ post.id }}">
            <button type="submit" class="bg-transparent outline-0 border-0 like-button">
                {% if user_name and post.id in like_counts %}
                <i class="fas fa-thumbs-up fa-1x"></i>
                {% else %}
                <i class="far fa-thumbs-up fa-1x"></i>
                {% endif %}
            </button>
            <p class="like-count ml-2 mt-4" data-object-id="{{ post.id }}">{{ total_like_count }}</p>
        </form>
    </div>
</div>
{% endfor %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="{% static 'js/likeButton.js' %}"></script>
{% endblock blog_content_three %}

{% block blog_content_four %}
<div class="box-4">
    {% if post %}
    <div class="d-flex align-items-center justify-content-between mt-2">
        <div class="d-flex align-items-center">
            <div class="rounded-circle bg-dk-blue overflow-hidden mx-1" style="width: 35px; height: 35px;"></div>
            <div class="ml-2">
                <h3 class="small"><strong>{{ post.user.username }}</strong></h3>
                <h3 class="small">Published: {{ post.timestamp }}</h3>
            </div>
        </div>
    </div>
    <h4 class="d-flex align-items-center">
        {{ post.title }}
        <form method="post" action="{% url 'like_toggle' %}" class="like-form d-flex align-items-center p-2">
            {% csrf_token %}
            <input type="hidden" name="object_id" value="{{ post.id }}">
            <button type="submit" class="bg-transparent outline-0 border-0 like-button">
                {% if user_name and post.id in like_counts %}
                <i class="fas fa-thumbs-up fa-1x text-success"></i>
                {% else %}
                <i class="far fa-thumbs-up fa-1x"></i>
                {% endif %}
            </button>
            <p class="like-count ml-2 mt-4" data-object-id="{{ post.id }}">{{ total_like_count }}</p>
        </form>
    </h4>
    <p>{{ post.content }}</p>
    <hr>

    <!-- Display existing comments if any -->
    <div class="existing-comments mt-3">
        <h3 class="mb-2 small">Comments:</h3>
        <ul class="list-unstyled">
            {% for comment in post.comments.all %}
            <li class="mb-2">
                <div class="comment-item d-flex align-items-center p-2 rounded" style="background-color: #f2f2f2;">
                    <div class="rounded-circle bg-dk-blue overflow-hidden mr-2" style="width: 25px; height: 25px;">
                    </div>
                    <strong>{{ comment.user.username }}</strong>: {{ comment.text }}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <hr>

    <!-- Comment box goes here -->
    <div class="comment-box mt-3">
        <form method="post" action="{% url 'add_comment' post.id %}">
            {% csrf_token %}
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <!--Need to add input fields for the user to enter their comment -->
            <textarea class="form-control" name="comment" rows="4" placeholder="Add your comment"></textarea>
            <button type="submit" class="btn bg-dk-blue mt-2">Add Comment</button>
        </form>
    </div>

    {% endif %}
</div>
{% endblock blog_content_four %}